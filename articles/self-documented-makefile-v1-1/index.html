<!DOCTYPE html><html class="" lang="en"><head><meta charset="utf-8"><meta content="width=device-width,initial-scale=1" name="viewport"><meta content="Yann Prono" property="og:site_name"><meta content="en-us" property="og:locale"><meta content="article" property="og:type"><meta content="https://mcdostone.github.io/articles/self-documented-makefile-v1-1/" property="og:url"><meta content="Yann Prono" property="og:title"><meta content="https:/mcdostone.github.io/assets/images/og-image.jpg" property="og:image"><meta content="452" property="og:image:width"><meta content="452" property="og:image:height"><meta content="A trick to print Makefile variables and their values." property="og:description"><meta content="summary" property="twitter:card"><meta content="https:/mcdostone.github.io/assets/images/og-image.jpg" property="twitter:image"><meta content="Yann Prono" property="twitter:title"><meta content="A trick to print Makefile variables and their values." property="twitter:description"><meta content="A trick to print Makefile variables and their values." name="description"><title>Self-Documented Makefile V1.1 | Yann Prono</title><link href="/favicon-bfe765527d.svg" rel="icon" type="image/svg+xml"><link href="https://mcdostone.github.io/index.xml" rel="alternate" type="application/atom+xml" title="Atom feed"><script defer src="/assets/js/dark-b76d63de.js" type="module"></script><link href="/assets/css/style-6f652cb1.css" rel="stylesheet"></head><body><header class="header"><div class="container"><div><a href="/" class="active">Blog</a></div></div></header><main class="article-container"><article><header><h1>Self-Documented Makefile V1.1</h1><time class="article-published-on" datetime="2022-07-26">July 26, 2022</time></header><p>I like Makefiles: The syntax is quite simple, it's easy to use and it's useful to group commands in one place. In 2016, Marmelab published an article on <a href="https://marmelab.com/blog/2016/02/29/auto-documented-makefile.html">documenting a Makefile</a>. With some shell script voodoo, you can run <code>make help</code> and it will print all the available targets and their descriptions. It works and it is simple. I've been using this trick for years and I'm happy with it.</p><p>Today I would like to go one step further: Let's improve the <code>help</code> target so it also outputs the variables and their values. To do so, we can read the internal database thanks to <code>make -p</code>. This command prints a lot of information: recipes, prerequisites, environment variables, variables and so on.</p><figure class="code-snippet"><span class="language-tag">bash</span><pre><code class="code-block-inner"><span class="line"><span class="h33">make -pn hello=there </span><span class="h7a"># -n for a dry run</span></span>
<span class="line"><span class="h7a"># environment</span></span>
<span class="line"><span class="h33">XAUTHORITY = /run/user/1000/gdm/Xauthority</span></span>
<span class="line"><span class="h7a"># environment</span></span>
<span class="line"><span class="h33">GDMSESSION = ubuntu</span></span>
<span class="line"><span class="h7a"># environment</span></span>
<span class="line"><span class="h33">XMODIFIERS = @im=ibus</span></span>
<span class="line"><span class="h7a"># makefile (from 'Makefile', line 3)</span></span>
<span class="line"><span class="h33">NPROC := 12</span></span>
<span class="line"><span class="h7a"># command line</span></span>
<span class="line"><span class="h33">hello = there</span></span>
<span class="line"><span class="h7a"># ....</span></span>
<span class="line"></span></code></pre></figure><p>A quick lookup to the output later, I can extract the relevant information with the command, nothing fancy here:</p><figure class="code-snippet"><span class="language-tag">bash</span><pre><code class="code-block-inner"><span class="line"><span class="h33">make -pn </span><span class="h69">|</span><span class="h33"> awk </span><span class="hbb">'/^# (makefile |command)/{getline; print}'</span></span>
<span class="line"></span></code></pre></figure><p>Finally, let's format and print the result. <code>Makefile</code> looks like this:</p><figure class="code-snippet"><span class="language-tag">Makefile</span><pre><code class="code-block-inner"><span class="line"><span class="h33">.DEFAULT_GOAL = help</span></span>
<span class="line"><span class="h33">NPROC := </span><span class="hbb">$(</span><span class="h07">shell</span><span class="hbb"> nproc)</span></span>
<span class="line"><span class="h33">HOST ?= 127.0.0.1</span></span>
<span class="line"></span>
<span class="line"><span class="h07">.PHONY</span><span class="h33">: help</span></span>
<span class="line"></span>
<span class="line"><span class="h4a">help</span><span class="h33">: </span><span class="h7a">## Show this help</span></span>
<span class="line"><span class="h33">	</span><span class="h69">@</span><span class="h33">echo "Variables:"</span></span>
<span class="line"><span class="h33">	</span><span class="h69">@</span><span class="h33">make -pnf </span><span class="hbb">$(</span><span class="h33">MAKEFILE_LIST</span><span class="hbb">)</span><span class="h33"> | awk '/^# (makefile |command)/{getline; print}' | grep -v "^MAKEFILE_LIST" | sort | uniq | awk 'BEGIN {FS = ":?= "}; {printf "  \033[36m%-30s\033[0m %s\n", </span><span class="h07">$$</span><span class="h33">1, </span><span class="h07">$$</span><span class="h33">2}'</span></span>
<span class="line"><span class="h33">	</span><span class="h69">@</span><span class="h33">echo "\nTargets:"</span></span>
<span class="line"><span class="h33">	</span><span class="h69">@</span><span class="h33">grep -E '^[/%a-zA-Z0-9_-]+: .*?## .*</span><span class="h07">$$</span><span class="h33">' </span><span class="hbb">$(</span><span class="h33">MAKEFILE_LIST</span><span class="hbb">)</span><span class="h33"> | sort | awk  'BEGIN {FS = ": .*?## "}; {printf "  \033[36m%-30s\033[0m %s\n", </span><span class="h07">$$</span><span class="h33">1, </span><span class="h07">$$</span><span class="h33">2}'</span></span>
<span class="line"></span></code></pre></figure><figure class="code-snippet"><span class="language-tag">bash</span><pre><code class="code-block-inner"><span class="line"><span class="h33">make </span><span class="h07">help</span><span class="h33"> hello=world</span></span>
<span class="line"><span class="h33">Variables:</span></span>
<span class="line"><span class="h33">  .DEFAULT_GOAL                  </span><span class="h07">help</span></span>
<span class="line"><span class="h33">  HOST                           127.0.0.1</span></span>
<span class="line"><span class="h33">  NPROC                          8</span></span>
<span class="line"><span class="h33">  hello                          world</span></span>
<span class="line"></span>
<span class="line"><span class="h33">Targets:</span></span>
<span class="line"><span class="h33">  </span><span class="h07">help</span><span class="h33">                           Show this </span><span class="h07">help</span></span>
<span class="line"></span></code></pre></figure></article></main><footer class="container"><div class="social-networks"><a href="https://github.com/mcdostone" aria-label="github profile"><svg class="icon github"><use href="/assets/images/icons-231b49900a.svg#github"></use></svg> </a><a href="/index.xml" aria-label="RSS feed"><svg class="icon rss"><use href="/assets/images/icons-231b49900a.svg#rss"></use></svg></a><div class="theme-selector"><button aria-label="Open a dialog box to choose a theme" type="button" aria-haspopup="menu"><svg class="icon theme"><use href="/assets/images/icons-231b49900a.svg#theme-light"></use></svg></button><dialog><form method="dialog"><button aria-label="switch to OS theme" type="button" value="" aria-selected=""><svg><use href="/assets/images/icons-231b49900a.svg#theme-system"></use></svg> OS Default</button> <button aria-label="switch to light theme" type="button" value="light"><svg><use href="/assets/images/icons-231b49900a.svg#theme-light"></use></svg> Light</button> <button aria-label="switch to dark theme" type="button" value="dark"><svg><use href="/assets/images/icons-231b49900a.svg#theme-dark"></use></svg> Dark</button></form></dialog></div></div></footer></body></html>