<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta content="width=device-width,initial-scale=1" name="viewport"><meta content="Yann Prono" property="og:site_name"><meta content="en-us" property="og:locale"><meta content="article" property="og:type"><meta content="https://mcdostone.github.io/articles/self-documented-makefile-v1-1/" property="og:url"><meta content="Yann Prono" property="og:title"><meta content="https:/mcdostone.github.io/assets/images/og-image.jpg" property="og:image"><meta content="452" property="og:image:width"><meta content="452" property="og:image:height"><meta content="A trick to print Makefile variables and their values." property="og:description"><meta content="summary" property="twitter:card"><meta content="https:/mcdostone.github.io/assets/images/og-image.jpg" property="twitter:image"><meta content="Yann Prono" property="twitter:title"><meta content="A trick to print Makefile variables and their values." property="twitter:description"><meta content="A trick to print Makefile variables and their values." name="description"><title>Self-Documented Makefile V1.1 | Yann Prono</title><link href="/favicon-4a62d83d7f.svg" rel="icon" type="image/svg+xml"><link href="https://mcdostone.github.io/index.xml" rel="alternate" type="application/atom+xml" title="Atom feed"><link href="/assets/css/style-caa32f75.css" rel="stylesheet"></head><body><header class="header"><div class="container"><div><a href="/" class="active">Blog</a></div></div></header><main class="article-container"><article><header class=""><h1>Self-Documented Makefile V1.1</h1><time class="article-published-on" datetime="2022-07-26">July 26, 2022</time></header><p>I like Makefiles: The syntax is quite simple, it's easy to use and it's useful to group commands in one place. In 2016, Marmelab published an article on <a href="https://marmelab.com/blog/2016/02/29/auto-documented-makefile.html">documenting a Makefile</a>. With some shell script voodoo, you can run <code>make help</code> and it will print all the available targets and their descriptions. It works and it is simple. I've been using this trick for years and I'm happy with it.</p><p>Today I would like to go one step further: Let's improve the <code>help</code> target so it also outputs the variables and their values. To do so, we can read the internal database thanks to <code>make -p</code>. This command prints a lot of information: recipes, prerequisites, environment variables, variables and so on.</p><figure class="code-snippet"><span class="language-tag">bash</span><pre style="background-color: #ffffff"><code class="code-block-inner"><span class="line"><span style="color: #24292F">make -pn hello=there </span><span style="color: #6E7781"># -n for a dry run</span></span>
<span class="line"><span style="color: #6E7781"># environment</span></span>
<span class="line"><span style="color: #24292F">XAUTHORITY = /run/user/1000/gdm/Xauthority</span></span>
<span class="line"><span style="color: #6E7781"># environment</span></span>
<span class="line"><span style="color: #24292F">GDMSESSION = ubuntu</span></span>
<span class="line"><span style="color: #6E7781"># environment</span></span>
<span class="line"><span style="color: #24292F">XMODIFIERS = @im=ibus</span></span>
<span class="line"><span style="color: #6E7781"># makefile (from 'Makefile', line 3)</span></span>
<span class="line"><span style="color: #24292F">NPROC := 12</span></span>
<span class="line"><span style="color: #6E7781"># command line</span></span>
<span class="line"><span style="color: #24292F">hello = there</span></span>
<span class="line"><span style="color: #6E7781"># ....</span></span>
<span class="line"></span></code></pre></figure><p>A quick lookup to the output later, I can extract the relevant information with the command, nothing fancy here:</p><figure class="code-snippet"><span class="language-tag">bash</span><pre style="background-color: #ffffff"><code class="code-block-inner"><span class="line"><span style="color: #24292F">make -pn </span><span style="color: #CF222E">|</span><span style="color: #24292F"> awk </span><span style="color: #0A3069">'/^# (makefile |command)/{getline; print}'</span></span>
<span class="line"></span></code></pre></figure><p>Finally, let's format and print the result. <code>Makefile</code> looks like this:</p><figure class="code-snippet"><span class="language-tag">Makefile</span><pre style="background-color: #ffffff"><code class="code-block-inner"><span class="line"><span style="color: #24292F">.DEFAULT_GOAL = help</span></span>
<span class="line"><span style="color: #24292F">NPROC := </span><span style="color: #0A3069">$(</span><span style="color: #0550AE">shell</span><span style="color: #0A3069"> nproc)</span></span>
<span class="line"><span style="color: #24292F">HOST ?= 127.0.0.1</span></span>
<span class="line"></span>
<span class="line"><span style="color: #0550AE">.PHONY</span><span style="color: #24292F">: help</span></span>
<span class="line"></span>
<span class="line"><span style="color: #8250DF">help</span><span style="color: #24292F">: </span><span style="color: #6E7781">## Show this help</span></span>
<span class="line"><span style="color: #24292F">	</span><span style="color: #CF222E">@</span><span style="color: #24292F">echo "Variables:"</span></span>
<span class="line"><span style="color: #24292F">	</span><span style="color: #CF222E">@</span><span style="color: #24292F">make -pnf </span><span style="color: #0A3069">$(</span><span style="color: #24292F">MAKEFILE_LIST</span><span style="color: #0A3069">)</span><span style="color: #24292F"> | awk '/^# (makefile |command)/{getline; print}' | grep -v "^MAKEFILE_LIST" | sort | uniq | awk 'BEGIN {FS = ":?= "}; {printf "  \033[36m%-30s\033[0m %s\n", </span><span style="color: #0550AE">$$</span><span style="color: #24292F">1, </span><span style="color: #0550AE">$$</span><span style="color: #24292F">2}'</span></span>
<span class="line"><span style="color: #24292F">	</span><span style="color: #CF222E">@</span><span style="color: #24292F">echo "\nTargets:"</span></span>
<span class="line"><span style="color: #24292F">	</span><span style="color: #CF222E">@</span><span style="color: #24292F">grep -E '^[/a-zA-Z0-9_-]+: .*?## .*</span><span style="color: #0550AE">$$</span><span style="color: #24292F">' </span><span style="color: #0A3069">$(</span><span style="color: #24292F">MAKEFILE_LIST</span><span style="color: #0A3069">)</span><span style="color: #24292F"> | sort | awk  'BEGIN {FS = ": .*?## "}; {printf "  \033[36m%-30s\033[0m %s\n", </span><span style="color: #0550AE">$$</span><span style="color: #24292F">1, </span><span style="color: #0550AE">$$</span><span style="color: #24292F">2}'</span></span>
<span class="line"></span></code></pre></figure><figure class="code-snippet"><span class="language-tag">bash</span><pre style="background-color: #ffffff"><code class="code-block-inner"><span class="line"><span style="color: #24292F">make </span><span style="color: #0550AE">help</span><span style="color: #24292F"> hello=world</span></span>
<span class="line"><span style="color: #24292F">Variables:</span></span>
<span class="line"><span style="color: #24292F">  .DEFAULT_GOAL                  </span><span style="color: #0550AE">help</span></span>
<span class="line"><span style="color: #24292F">  HOST                           127.0.0.1</span></span>
<span class="line"><span style="color: #24292F">  NPROC                          8</span></span>
<span class="line"><span style="color: #24292F">  hello                          world</span></span>
<span class="line"></span>
<span class="line"><span style="color: #24292F">Targets:</span></span>
<span class="line"><span style="color: #24292F">  </span><span style="color: #0550AE">help</span><span style="color: #24292F">                           Show this </span><span style="color: #0550AE">help</span></span>
<span class="line"></span></code></pre></figure></article></main><footer class="container"><div class="social-networks"><a href="https://github.com/mcdostone" aria-label="github"><svg class="icon github"><use href="/assets/images/icons-7d41602f73.svg#github"></use></svg> </a><a href="/index.xml" aria-label="rss"><svg class="icon rss"><use href="/assets/images/icons-7d41602f73.svg#rss"></use></svg></a></div></footer></body></html>